---
title: Linux大内存应用进程被杀-读写4GB文件记录
date: 2022-4-10 15点39分
categories: [杂记,Linux]
tags: Linux编程
---



# 前言

最近搞MPI实验，与其说在搞并行计算，还不如说在搞操作系统...入门最大的问题还不是MPI编程，就是搞系统优化就够呛的。无论是Windows还是Linux，对于吃超大内存的应用都不是十分友好，以往没有什么超大规模数据处理、大内存应用的处理经验。故此记录一般。

# 问题

简单描述一下简单的应用场景：需要生成一大批随机数据(float类型，大小在0-1之间)，最大大小位4GB。然后从文件中读取数据，使用qsort对数据进行排序。

问题：4GB float数据，需要至少16G的内存空间，差不多超出了物理RAM的大小。强行执行的话，会在运行一段时间后，程序被杀掉。xxx(进程ID) is killed。

# 解决

在开始聊解决方案之前，先来过一下Linux操作系统的一些配置请求命令。

## Linux查看配置

1. 查看系统配置，汇总信息CPU、内存、硬盘、网络等等：

   ```bash
   sudo lshw | grep less
   输出：
   olimi-pc                    
       description: Computer
       width: 64 bits
       capabilities: smp vsyscall32
     *-core
          description: Motherboard
          physical id: 0
        *-memory
             description: System memory
             physical id: 1
             size: 12GiB
        *-cpu
             product: Intel(R) Core(TM) i5-7300HQ CPU @ 2.50GHz
             vendor: Intel Corp.
             physical id: 2
             bus info: cpu@0
             width: 64 bits
             capabilities: fpu fpu_exception wp vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp x86-64 constant_tsc rep_good nopl xtopology cpuid pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 movbe popcnt aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single pti ssbd ibrs ibpb stibp fsgsbase bmi1 avx2 smep bmi2 erms invpcid rdseed adx smap clflushopt xsaveopt xsavec xgetbv1 xsaves md_clear flush_l1d arch_capabilities
        *-display
             description: 3D controller
             product: Microsoft Corporation
             vendor: Microsoft Corporation
             physical id: 0
             bus info: pci@cd21:00:00.0
             version: 00
             width: 32 bits
             clock: 33MHz
             capabilities: bus_master cap_list
             configuration: driver=dxgkrnl latency=0
             resources: irq:0
        *-scsi
             physical id: 3
             logical name: scsi0
           *-disk:0
                description: EXT4 volume
                product: Virtual Disk
                vendor: Linux
                physical id: 0.0.0
                bus info: scsi@0:0.0.0
                logical name: /dev/sda
                version: 1.0
                serial: 3255683f-53a2-4fdf-91cf-b4c1041e2a62
                size: 256GiB
                capabilities: journaled extended_attributes large_files huge_files dir_nlink recover 64bit extents ext4 ext2 initialized
                configuration: ansiversion=5 created=2019-04-11 00:35:05 filesystem=ext4 lastmountpoint=/swap logicalsectorsize=512 modified=2022-04-10 11:06:59 mounted=2022-04-10 11:06:59 sectorsize=4096 state=clean
           *-disk:1
                description: EXT4 volume
                product: Virtual Disk
                vendor: Linux
                physical id: 0.0.1
                bus info: scsi@0:0.0.1
                logical name: /dev/sdb
                logical name: /
                version: 1.0
                serial: 3255683f-53a2-4fdf-91cf-b4c1041e2a62
                size: 256GiB
                capabilities: journaled extended_attributes large_files huge_files dir_nlink recover 64bit extents ext4 ext2 initialized
                configuration: ansiversion=5 created=2019-04-11 00:35:05 filesystem=ext4 lastmountpoint=/distros logicalsectorsize=512 modified=2022-04-10 11:07:01 mount.fstype=ext4 mount.options=rw,relatime,discard,errors=remount-ro,data=ordered mounted=2022-04-10 11:07:01 sectorsize=4096 state=mounted
     *-network:0 DISABLED
          description: Ethernet interface
          physical id: 1
          logical name: bond0
          serial: 6e:14:5b:8f:54:0e
          capabilities: ethernet physical
          configuration: autonegotiation=off broadcast=yes driver=bonding driverversion=5.10.16.3-microsoft-standard-WS firmware=2 link=no master=yes multicast=yes
     *-network:1 DISABLED
          description: Ethernet interface
          physical id: 2
          logical name: dummy0
          serial: ea:b4:ca:e1:ed:db
          capabilities: ethernet physical
          configuration: broadcast=yes driver=dummy driverversion=5.10.16.3-microsoft-standard-WS
     *-network:2
          description: Ethernet interface
          physical id: 3
          logical name: eth0
          serial: 00:15:5d:08:47:9a
          size: 10Gbit/s
          capabilities: ethernet physical
          configuration: autonegotiation=off broadcast=yes driver=hv_netvsc driverversion=5.10.16.3-microsoft-standard-WS duplex=full firmware=N/A ip=192.168.33.43 link=yes multicast=yes speed=10Gbit/s
   ```

   信息显示太多，可以单独只输出某个部分，比如：

   ```bash
   $ sudo lshw -c cpu -c memory
     *-memory                  
          description: System memory
          physical id: 1
          size: 12GiB
     *-cpu
          product: Intel(R) Core(TM) i5-7300HQ CPU @ 2.50GHz
          vendor: Intel Corp.
          physical id: 2
          bus info: cpu@0
          width: 64 bits
          capabilities: fpu fpu_exception wp vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp x86-64 constant_tsc rep_good nopl xtopology cpuid pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 movbe popcnt aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single pti ssbd ibrs ibpb stibp fsgsbase bmi1 avx2 smep bmi2 erms invpcid rdseed adx smap clflushopt xsaveopt xsavec xgetbv1 xsaves md_clear flush_l1d arch_capabilities
   ```

2. 单独的一些查看，CPU(静态信息):

   ```bash
   $ cat /proc/cpuinfo | grep model\ name	
   ```

3. 内存Memory(动态信息)：

   ```bash
   $ free -mh
                 total        used        free      shared  buff/cache   available
   Mem:            12G        263M         12G         64K         74M         11G
   Swap:          4.0G        241M        3.8G
   ```

   > free - Display amount of free and used memory in the system

4. 查看硬盘信息(动态)：

   ```bash
   $ df -lh   
   Filesystem      Size  Used Avail Use% Mounted on
   /dev/sdb        251G  8.7G  230G   4% /
   tmpfs           6.2G     0  6.2G   0% /mnt/wsl
   tools           118G   61G   57G  52% /init
   none            6.2G     0  6.2G   0% /dev
   none            6.2G  8.0K  6.2G   1% /run
   none            6.2G     0  6.2G   0% /run/lock
   none            6.2G     0  6.2G   0% /run/shm
   none            6.2G     0  6.2G   0% /run/user
   tmpfs           6.2G     0  6.2G   0% /sys/fs/cgroup
   drivers         118G   61G   57G  52% /usr/lib/wsl/drivers
   lib             118G   61G   57G  52% /usr/lib/wsl/lib
   # 我这是WSL
   ```

   > df - report file system disk space usage

5. 显卡：

   ```bash
   $ lspci       
   cd21:00:00.0 3D controller: Microsoft Corporation Device 008e
   # 我这还是WSL
   ```

   

Linux与windows不同(大部分情况下没有图形界面)，主要是在命令行界面中，查看单独某一个信息比汇总的信息舒服，所以记忆一下主要几种资源的查看方式还是有好处的。

## 编程

对于程序语言中的高级接口来说，一般不需要考虑调用接口的数据大小。数据读写由接口内部缓冲机制来保证。比如C语言中，fwrite和fread，一般来说可以直接相信它们能够正确调用(而无论数据的大小)。如果是特别大的文件，在Linux中启用64位文件偏移(默认32位，即long类型长度)，则可以添加CFLAGSS，-D_FILE_OFFSET_BITS=64

示例：

```bash
$ gcc make_data.c -o make-data -D_FILE_OFFSET_BITS=64
```

另外，如果从高层考虑数据大小(或者程序空间的大小，堆空间、栈空间等)，可以考虑把数据切块：

```C
    // handle big data
    unsigned long handled_number = 0;
    unsigned long number_of_Gb = 1073741824;
    while (N > number_of_Gb)
    {
        fwrite(data + handled_number, sizeof(float), number_of_Gb, file);
        handled_number += number_of_Gb;
        N -= number_of_Gb;
    }
    fwrite(data + handled_number, sizeof(float), N, file);
```

但是对一般排序算法，数据需要一起加载，则无法使用。

## 系统配置

要使上述的程序顺利完成，在最恶劣情况需要将4GB数据、float类型，读取到内存中，对于程序来说，4G*4，至少需要16GB的**逻辑内存(**不一定需要这么强的物理资源)。我们的物理资源，即内存条可能只有8G、或者16G，在虚拟机中不一定能分配到这么大的资源。这个时候就需要**虚拟内存**的技术。只要保证虚拟内存+RAM大于程序需要的逻辑内存即可。反过来，如果虚拟内存+RAM小于程序需要的逻辑内存，那么程序必然会访问超出逻辑地址空间的资源，导致程序被杀掉。所以程序不能跑起来一定要检查内存是不是被吃光了。

下面是Linux上设置虚拟内存的方式(在Linux中需要做的是设置交换文件，即swap)

1. 执行“sudo swapon -s”命令，查看是否已经存在swap file

   如果第一步存在swapfile则需要先禁用

```undefined
sudo swapoff /swapfile
```

2. 修改swap 空间的大小为8G

```swift
sudo dd if=/dev/zero of=/swapfile bs=1M count=8192
```

3. 设置文件为“swap file”类型

```undefined
sudo mkswap /swapfile
```

4. 启用swapfile

```undefined
sudo swapon /swapfile
```

链接：https://www.jianshu.com/p/e656bead51ee

**注意(坑)：以上操作必须一起完成！！否则在swapoff了原本的swapfile之后会导致无法开机。因为系统没办法挂载原本的swapfile。如果中间没完成，记得重新把/swapfile挂载回去！**

然后如果是使用WSL，配置方式：

添加文件`.wslconfig`，文件路径为 `C:\Users\<UserName>\.wslconfig`.文件内容：

```bash
# Settings apply across all Linux distros running on WSL 2
[wsl2]

# Sets amount of swap storage space to 8GB, default is 25% of available RAM
swap=40GB
```

注意如果是动态修改不能更改swap位置，否则不能生效(这里跟上面linux同理，不能更改系统原本的swapfile文件，否则会导致系统损坏，或者不起效)。要更改swap位置，必须重装或新安装时就指定。

更多设置和解释：

[WSL高级设置配置-官网](https://docs.microsoft.com/zh-cn/windows/wsl/wsl-config)

[Understanding your WSL2 RAM and swap - Changing the default 50%-25%](https://joe.blog.freemansoft.com/2022/01/setting-your-memory-and-swap-for-wsl2.html)

配置完成后，实测4GB数据能够正常运行，4GB float数据排序，需要时间：1.310827E+03(排序时间)。

## 意外

在VMWare虚拟机配置swap过程中，踩了一个坑，就是上面提到swapoff之后没完成整个过程就关机了，导致无法启动。

整个过程主要是，在分配swap10GB空间时，磁盘刚好满了。然后就想关机扩展磁盘空间。然后扩展磁盘空间又必须把快照删了...然后就启动不了(原因在上面提了)。寄。

咋办呢。**解决：**开启时，查看下方一行提示，按ESC进入高级选项，选择ubuntu recovery mode，选择root，进入命令行。把原本占满磁盘空间的swapfile改小一点，重新挂载上swapfile，重启即可(具体命令参见上面)。

扩展磁盘的方式：VMWare，点击磁盘大小，将最大大小改大，启动后使用gparted挂载空间(这是图形化方式，不能用图形化用自带的fdisk)

